// middleware/auth.js - Middleware simplificado
const jwt = require('jsonwebtoken');
require('dotenv').config();

const JWT_SECRET = process.env.JWT_SECRET || 'baconfort_jwt_secret_super_seguro_2024_cambiar_en_produccion';

// Admin credentials v√°lidas
const ADMIN_CREDENTIALS = {
  email: 'baconfort.centro@gmail.com',
  password: 'roccosa226',
  role: 'admin'
};

// Middleware de autenticaci√≥n
const authenticateToken = (req, res, next) => {
  const authHeader = req.headers['authorization'];
  const token = authHeader && authHeader.split(' ')[1]; // Bearer TOKEN
  
  console.log('üîë Auth middleware - Token recibido:', token ? 'S√ç' : 'NO');
  console.log('üîç Token completo:', token);
  
  if (!token) {
    console.log('‚ùå No token provided');
    return res.status(401).json({ 
      success: false, 
      error: 'Token requerido' 
    });
  }
  
  // Token de emergencia para bypass (solo para desarrollo)
  if (req.query.bypass === 'true' && req.query.emergency === 'true' && token === 'ADMIN_BYPASS_TOKEN_EMERGENCY_ACCESS') {
    console.log('‚ö†Ô∏è ADVERTENCIA: Usando token de emergencia para bypass de autenticaci√≥n');
    req.user = {
      id: 'admin_emergency_bypass',
      email: ADMIN_CREDENTIALS.email,
      role: 'admin',
      name: 'Emergency Admin',
      bypassEmergency: true
    };
    return next();
  }
  
  // Verificar tokens est√°ticos con formato espec√≠fico (admin_static_)
  if (token.match(/^admin_static_\d{8}_\d{5}_baconfort$/)) {
    console.log('‚úÖ Token est√°tico de administrador aceptado');
    req.user = {
      id: 'admin_static',
      email: ADMIN_CREDENTIALS.email,
      role: 'admin',
      name: 'Static Admin'
    };
    return next();
  }
  
  // Verificar tokens simples del sistema (incluyendo tokens LOCAL_)
  if (token.startsWith('admin_token_') || 
      token.startsWith('BACONFORT_ADMIN_TOKEN_') ||
      token.startsWith('session_') ||
      token.startsWith('LOCAL_') ||
      token === 'admin_baconfort_2025' ||
      token === 'BACONFORT_ADMIN_2025_7D3F9K2L') {
    console.log('‚úÖ Token admin reconocido:', token.substring(0, 20) + '...');
    req.user = {
      id: 'admin_baconfort_2025',
      email: ADMIN_CREDENTIALS.email,
      role: ADMIN_CREDENTIALS.role,
      name: 'Administrator'
    };
    return next();
  }
  
  // Verificar tokens de usuario regular - ESTOS SON TOKENS LEGACY, NO USAR
  if (token.startsWith('user_token_')) {
    console.log('‚ö†Ô∏è Token legacy reconocido (NO RECOMENDADO):', token.substring(0, 20) + '...');
    console.log('‚ö†Ô∏è Los tokens user_token_ son legacy y deber√≠an migrar a JWT');
    
    // En lugar de hardcodear, intentar extraer info del token o rechazar
    return res.status(401).json({ 
      success: false, 
      error: 'Token legacy no soportado. Por favor, inicia sesi√≥n nuevamente.',
      code: 'LEGACY_TOKEN_DEPRECATED'
    });
  }
  
  // Verificar JWT
  jwt.verify(token, JWT_SECRET, (err, user) => {
    if (err) {
      console.log('‚ùå Token inv√°lido:', err.message);
      
      // Si es token expirado, dar informaci√≥n m√°s espec√≠fica
      if (err.name === 'TokenExpiredError') {
        console.log('‚è∞ Token expirado en:', new Date(err.expiredAt));
        return res.status(401).json({ 
          success: false, 
          error: 'Token expirado',
          code: 'TOKEN_EXPIRED',
          expiredAt: err.expiredAt
        });
      }
      
      return res.status(403).json({ 
        success: false, 
        error: 'Token inv√°lido',
        code: 'TOKEN_INVALID'
      });
    }
    
    console.log('‚úÖ Token JWT v√°lido, datos del usuario:', JSON.stringify(user, null, 2));
    req.user = user;
    next();
  });
};

// Middleware espec√≠fico para admin
const requireAdmin = (req, res, next) => {
  if (!req.user || req.user.role !== 'admin') {
    console.log('‚ùå Acceso denegado - No es admin');
    return res.status(403).json({ 
      success: false, 
      error: 'Acceso denegado' 
    });
  }
  
  console.log('‚úÖ Acceso admin autorizado');
  next();
};

// Middleware de autenticaci√≥n opcional (no requiere token)
const optionalAuth = (req, res, next) => {
  const authHeader = req.headers['authorization'];
  const token = authHeader && authHeader.split(' ')[1];
  
  if (token) {
    // Token de emergencia para bypass
    if (req.query.bypass === 'true' && req.query.emergency === 'true' && token === 'ADMIN_BYPASS_TOKEN_EMERGENCY_ACCESS') {
      console.log('‚ö†Ô∏è ADVERTENCIA: Usando token de emergencia en optionalAuth');
      req.user = {
        id: 'admin_emergency_bypass',
        email: ADMIN_CREDENTIALS.email,
        role: 'admin',
        bypassEmergency: true
      };
    }
    // Token est√°tico de formato espec√≠fico
    else if (token.match(/^admin_static_\d{8}_\d{5}_baconfort$/)) {
      req.user = {
        id: 'admin_static',
        email: ADMIN_CREDENTIALS.email,
        role: 'admin'
      };
    }
    // Si hay token, intentar verificarlo
    else if (token.startsWith('admin_token_') || 
        token.startsWith('BACONFORT_ADMIN_TOKEN_') ||
        token.startsWith('session_') ||
        token === 'admin_baconfort_2025' ||
        token === 'BACONFORT_ADMIN_2025_7D3F9K2L') {
      req.user = {
        id: 'admin_baconfort_2025',
        email: ADMIN_CREDENTIALS.email,
        role: ADMIN_CREDENTIALS.role
      };
    } else if (token.startsWith('user_token_')) {
      // Tokens legacy - no configurar usuario autom√°ticamente
      console.log('‚ö†Ô∏è Token legacy detectado en optionalAuth - ignorando');
      // No establecer req.user para tokens legacy
    } else {
      jwt.verify(token, JWT_SECRET, (err, user) => {
        if (!err) {
          req.user = user;
        }
      });
    }
  }
  
  // Continuar sin importar si hay token o no
  next();
};

// Alias para compatibilidad - Combina auth + admin
const adminAuth = (req, res, next) => {
  // Primero autenticar
  authenticateToken(req, res, (err) => {
    if (err) return; // Si hay error, authenticateToken ya manej√≥ la respuesta
    
    // Luego verificar que sea admin
    requireAdmin(req, res, next);
  });
};

module.exports = {
  authenticateToken,
  requireAdmin,
  optionalAuth,
  adminAuth,
  ADMIN_CREDENTIALS,
  JWT_SECRET
};
